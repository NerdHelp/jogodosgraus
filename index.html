<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Jogo dos Graus Musicais</title>
<style>
  * {
    box-sizing: border-box;
  }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
    background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
    color: white;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
  }
  h1 {
    margin-top: 20px;
    margin-bottom: 10px;
    font-size: 2.5rem;
    text-shadow: 1px 1px 3px #000;
    user-select: none;
  }
  #game-container {
    background-color: #1f2933;
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.7);
    max-width: 800px;
    width: 95%;
    text-align: center;
    display: flex;
    gap: 30px;
    justify-content: center;
    align-items: flex-start;
  }

  /* Cont√™ineres laterais do nome e ranking */
  #name-screen, #ranking-container {
    background-color: #28343f;
    border-radius: 15px;
    padding: 20px;
    box-shadow: inset 0 0 10px #111;
  }

  #name-screen {
    flex: 1;
    min-width: 260px;
  }

  #ranking-container {
    flex: 1;
    max-width: 300px;
    color: #ccc;
    font-size: 1rem;
    user-select: none;
  }

  #ranking-container h3 {
    margin-top: 0;
    margin-bottom: 15px;
    color: #59a6ff;
  }

  #ranking-list {
    list-style: decimal inside;
    max-height: 320px;
    overflow-y: auto;
    padding-left: 0;
  }
  #ranking-list li {
    margin-bottom: 8px;
  }

  /* Tela do jogo e demais telas centralizadas abaixo */
  #start-screen, #game-screen, #end-screen {
    margin-top: 30px;
    background-color: #1f2933;
    padding: 25px 30px;
    border-radius: 20px;
    max-width: 520px;
    width: 95%;
    box-shadow: 0 0 20px rgba(0,0,0,0.7);
  }

  .btn {
    padding: 12px 24px;
    margin: 10px 5px;
    font-size: 1.1rem;
    border: none;
    border-radius: 12px;
    background-color: #3498db;
    color: white;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
    user-select: none;
  }
  .btn:hover {
    background-color: #2980b9;
    transform: scale(1.05);
  }
  input {
    padding: 12px;
    font-size: 1.3rem;
    border-radius: 8px;
    border: none;
    margin-top: 15px;
    width: 85%;
    text-align: center;
    user-select: text;
    transition: box-shadow 0.3s ease;
  }
  input:focus {
    outline: none;
    box-shadow: 0 0 8px #3498db;
  }
  .hidden {
    display: none;
  }
  #result {
    margin-top: 20px;
    font-size: 1.6rem;
    min-height: 2em;
    user-select: none;
    font-weight: 700;
    transition: color 0.4s ease;
  }
  #timer {
    font-size: 1.5rem;
    font-weight: bold;
    color: #ffcc00;
    margin-top: 15px;
    user-select: none;
  }
  #question {
    font-size: 1.7rem;
    font-weight: 600;
    user-select: none;
  }

  /* Bot√£o voltar aparece s√≥ durante o jogo */
  #btn-back-home {
    background-color: #e74c3c;
    margin-top: 20px;
  }
  #btn-back-home:hover {
    background-color: #c0392b;
  }

  /* Responsividade: em telas pequenas, ranking fica abaixo do nome */
  @media (max-width: 700px) {
    #game-container {
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }
    #name-screen, #ranking-container {
      max-width: 100%;
      width: 100%;
    }
  }
</style>
</head>
<body>
<h1>üéµ Jogo dos Graus Musicais</h1>
<div id="game-container">

  <!-- Tela para digitar nome -->
  <div id="name-screen">
    <p>Digite seu nome para come√ßar:</p>
    <input type="text" id="player-name" placeholder="Seu nome aqui" autocomplete="off" autocorrect="off" autocapitalize="words" spellcheck="false" />
    <button class="btn" id="btn-confirm-name">Confirmar</button>
  </div>

  <!-- Ranking ao lado -->
  <div id="ranking-container">
    <h3>Ranking Geral</h3>
    <ol id="ranking-list">
      <li>Carregando...</li>
    </ol>
  </div>

</div>

<!-- Tela para escolher dificuldade -->
<div id="start-screen" class="hidden">
  <p>Escolha a dificuldade:</p>
  <button class="btn" onclick="startGame('facil')">F√°cil</button>
  <button class="btn" onclick="startGame('medio')">M√©dio</button>
  <button class="btn" onclick="startGame('dificil')">Dif√≠cil</button>
</div>

<!-- Tela do jogo -->
<div id="game-screen" class="hidden">
  <p id="question"></p>
  <div id="timer">Tempo: 15s</div>
  <input type="text" id="answer" placeholder="Digite sua resposta (ex: D, F#m, G#)..." autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" />
  <button class="btn" onclick="checkAnswer()">Responder</button>
  <button class="btn" id="btn-back-home">Voltar para o In√≠cio</button>
  <p id="result"></p>
</div>

<!-- Tela de fim de jogo e ranking -->
<div id="end-screen" class="hidden">
  <p>Fim de jogo, <span id="display-player-name"></span>! Sua pontua√ß√£o: <span id="final-score"></span></p>
  <button class="btn" onclick="restartGame()">Reiniciar</button>
</div>

<script>
const sounds = {
  acerto: new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8A'),
  erro: new Audio('data:audio/wav;base64,UklGRjQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8A'),
  click: new Audio('data:audio/wav;base64,UklGRlQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YSQAAAAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8A')
};

const notasCompletas = {
  'C': ['C', 'Dm', 'Em', 'F', 'G', 'Am'],
  'D': ['D', 'Em', 'F#m', 'G', 'A', 'Bm'],
  'E': ['E', 'F#m', 'G#m', 'A', 'B', 'C#m'],
  'F': ['F', 'Gm', 'Am', 'Bb', 'C', 'Dm'],
  'G': ['G', 'Am', 'Bm', 'C', 'D', 'Em'],
  'A': ['A', 'Bm', 'C#m', 'D', 'E', 'F#m'],
  'B': ['B', 'C#m', 'D#m', 'E', 'F#', 'G#m']
};

const escalaCompletaDificil = {
  'C': ['C', 'Dm', 'Em', 'F', 'G', 'Am', 'Bdim'],
  'D': ['D', 'Em', 'F#m', 'G', 'A', 'Bm', 'C#dim'],
  'E': ['E', 'F#m', 'G#m', 'A', 'B', 'C#m', 'D#dim'],
  'F': ['F', 'Gm', 'Am', 'Bb', 'C', 'Dm', 'Edim'],
  'G': ['G', 'Am', 'Bm', 'C', 'D', 'Em', 'F#dim'],
  'A': ['A', 'Bm', 'C#m', 'D', 'E', 'F#m', 'G#dim'],
  'B': ['B', 'C#m', 'D#m', 'E', 'F#', 'G#m', 'A#dim']
};

const grausFacilMedio = [1, 2, 3, 4, 5, 6];
const grausDificil = [1, 2, 3, 4, 5, 6, 7];

const API_URL = 'http://localhost:3000'; // Troque pelo seu backend real

let playerName = '';
let dificuldade = '';
let pontuacao = 0;
let grauAtual = 0;
let timer;
let timeLeft = 15;
let tomAtual = '';

// Inicializa
window.onload = () => {
  carregarRanking();
};

document.getElementById('btn-confirm-name').onclick = () => {
  const nomeInput = document.getElementById('player-name');
  const nome = nomeInput.value.trim();
  if (!nome) {
    alert('Por favor, digite seu nome.');
    nomeInput.focus();
    return;
  }
  playerName = nome;
  sounds.click.play();
  document.getElementById('name-screen').classList.add('hidden');
  document.getElementById('start-screen').classList.remove('hidden');
};

function startGame(nivel) {
  dificuldade = nivel;
  pontuacao = 0;
  grauAtual = 0;
  document.getElementById('start-screen').classList.add('hidden');
  document.getElementById('game-screen').classList.remove('hidden');
  document.getElementById('result').textContent = '';
  proximaPergunta();
}

function proximaPergunta() {
  clearInterval(timer);
  timeLeft = 15;
  document.getElementById('timer').textContent = `Tempo: ${timeLeft}s`;
  grauAtual++;
  if ((dificuldade === 'facil' || dificuldade === 'medio') && grauAtual > 10) {
    fimDeJogo();
    return;
  }
  if (dificuldade === 'dificil' && grauAtual > 15) {
    fimDeJogo();
    return;
  }
  tomAtual = geraTomAleatorio();
  const graus = dificuldade === 'dificil' ? grausDificil : grausFacilMedio;
  const grauPergunta = graus[Math.floor(Math.random() * graus.length)];
  mostraPergunta(tomAtual, grauPergunta);
  startTimer();
}

function geraTomAleatorio() {
  const tons = Object.keys(notasCompletas);
  return tons[Math.floor(Math.random() * tons.length)];
}

function mostraPergunta(tom, grau) {
  const texto = `Qual √© o acorde do grau ${grau} em ${tom}?`;
  document.getElementById('question').textContent = texto;
  const answerInput = document.getElementById('answer');
  answerInput.value = '';
  answerInput.dataset.grau = grau;
  answerInput.dataset.tom = tom;
  document.getElementById('result').textContent = '';
  answerInput.focus();
}

function startTimer() {
  timer = setInterval(() => {
    timeLeft--;
    document.getElementById('timer').textContent = `Tempo: ${timeLeft}s`;
    if (timeLeft <= 0) {
      clearInterval(timer);
      mostrarResultado(false, 'Tempo esgotado!');
      setTimeout(proximaPergunta, 1500);
    }
  }, 1000);
}

function checkAnswer() {
  clearInterval(timer);
  const respostaInput = document.getElementById('answer');
  const resposta = respostaInput.value.trim();
  const grau = Number(respostaInput.dataset.grau);
  const tom = respostaInput.dataset.tom;

  if (!resposta) {
    alert('Digite sua resposta!');
    startTimer();
    return;
  }

  let acordesPossiveis;
  if (dificuldade === 'dificil') {
    acordesPossiveis = escalaCompletaDificil[tom];
  } else {
    acordesPossiveis = notasCompletas[tom];
  }

  const indiceEsperado = grau - 1;
  const respostaCorreta = acordesPossiveis[indiceEsperado];

  if (resposta.toLowerCase() === respostaCorreta.toLowerCase()) {
    pontuacao++;
    sounds.acerto.play();
    mostrarResultado(true, 'Acertou!');
  } else {
    sounds.erro.play();
    mostrarResultado(false, `Errou! Resposta correta: ${respostaCorreta}`);
  }

  setTimeout(proximaPergunta, 1500);
}

function mostrarResultado(acertou, msg) {
  const resultEl = document.getElementById('result');
  resultEl.textContent = msg;
  resultEl.style.color = acertou ? '#2ecc71' : '#e74c3c';
}

function fimDeJogo() {
  clearInterval(timer);
  document.getElementById('game-screen').classList.add('hidden');
  document.getElementById('end-screen').classList.remove('hidden');
  document.getElementById('final-score').textContent = pontuacao;
  document.getElementById('display-player-name').textContent = playerName;
  enviarPontuacao(playerName, pontuacao);
  carregarRanking();
}

function restartGame() {
  document.getElementById('end-screen').classList.add('hidden');
  document.getElementById('name-screen').classList.remove('hidden');
  pontuacao = 0;
  grauAtual = 0;
  playerName = '';
  document.getElementById('player-name').value = '';
}

document.getElementById('btn-back-home').onclick = () => {
  clearInterval(timer);
  // Limpar campos e voltar para tela inicial
  document.getElementById('game-screen').classList.add('hidden');
  document.getElementById('name-screen').classList.remove('hidden');
  pontuacao = 0;
  grauAtual = 0;
  playerName = '';
  document.getElementById('player-name').value = '';
  document.getElementById('result').textContent = '';
};

// Envia pontua√ß√£o para o backend
async function enviarPontuacao(nome, pontuacao) {
  try {
    const res = await fetch(`${API_URL}/submit-score`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ nome, pontuacao }),
    });
    const data = await res.json();
    if (!data.sucesso) {
      console.warn('Erro ao enviar pontua√ß√£o:', data.error);
    }
  } catch (e) {
    console.warn('Falha na conex√£o com backend:', e);
  }
}

// Puxa ranking do backend
async function carregarRanking() {
  try {
    const res = await fetch(`${API_URL}/ranking`);
    const ranking = await res.json();
    const rankingList = document.getElementById('ranking-list');
    if (ranking.length === 0) {
      rankingList.innerHTML = '<li>Nenhuma pontua√ß√£o registrada ainda.</li>';
      return;
    }
    rankingList.innerHTML = ranking
      .map((item, i) => `<li><strong>${i + 1}¬∫</strong> ${item.nome} - ${item.pontuacao} pts</li>`)
      .join('');
  } catch (e) {
    console.warn('Erro ao carregar ranking:', e);
    document.getElementById('ranking-list').innerHTML = '<li>Erro ao carregar ranking.</li>';
  }
}
</script>
</body>
</html>
